<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA G√©n√©ratrice de Sites</title>
    <link rel="stylesheet" href="../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body>
    <h1>IA G√©n√©ratrice de Sites Web</h1>

    <div id="chat-box" class="chat-box"></div>
    <input type="text" id="user-input" class="user-input" placeholder="D√©cris ton site (ex : 'un site de portfolio simple')">
    <button onclick="askAI()" class="button">G√©n√©rer</button>
    <button onclick="clearChat()" class="button clear-button">Effacer</button>

    <h2>R√©sultat :</h2>
    <iframe id="site-preview" style="width: 90%; height: 400px; border: 1px solid #555; border-radius: 10px; background: white;"></iframe>
    <div id="button-row">
      <button onclick="downloadSite()" class="button download-button">üíæ T√©l√©charger le site (.html)</button>
      <button onclick="openInNewTab()" class="button open-button">üß≠ Ouvrir dans un onglet</button>
      <button onclick="downloadZip()" class="button zip-button">üì¶ T√©l√©charger en .zip</button>
    </div>


    <footer>
        <p>¬© 2025 ConfluoAiHub by ib2m_official</p>
    </footer>

    <script>
        let messages = JSON.parse(localStorage.getItem('chatSiteGen')) || [];
        const chatBox = document.getElementById("chat-box");
        const iframe = document.getElementById("site-preview");

        function updateChatBox() {
            chatBox.innerHTML = messages.map(m => `<p class="message"><strong>${m.role === 'user' ? 'Toi' : 'IA'} :</strong> ${m.role === 'user' ? m.content : "[Site g√©n√©r√© ci-dessous]"}</p>`).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        updateChatBox();

        async function askAI() {
            const userInput = document.getElementById("user-input").value;
            if (!userInput) return;

            messages.push({ role: "user", content: userInput });
            updateChatBox();
            document.getElementById("user-input").value = "";

            const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer CjVcFT9mRjOtTqG7er5Z5uYe4Y6h2yjU"
                },
                body: JSON.stringify({
                    model: "mistral-medium",
                    messages: [
                        ...messages,
                        {
                            role: "user",
                            content: `G√©n√®re une page HTML compl√®te interactive (avec CSS et JS internes) correspondant √† cette demande : "${userInput}". Ne donne que le code HTML complet. N'inclus aucun commentaire, ni explication.`
                        }
                    ],
                    temperature: 0.8
                })
            });

            const data = await response.json();
            const htmlCode = data.choices?.[0]?.message?.content || "<html><body><h1>Erreur de g√©n√©ration</h1></body></html>";

            messages.push({ role: "assistant", content: htmlCode });
            localStorage.setItem('chatSiteGen', JSON.stringify(messages));
            updateChatBox();

            const blob = new Blob([htmlCode], { type: 'text/html' });
            const blobURL = URL.createObjectURL(blob);
            iframe.src = blobURL;
        }

        function clearChat() {
            messages = [];
            localStorage.removeItem('chatSiteGen');
            updateChatBox();
            iframe.src = 'about:blank';
        }

        function downloadSite() {
          const lastResponse = messages.slice().reverse().find(m => m.role === 'assistant');
          if (!lastResponse) return alert("Aucun site g√©n√©r√© √† t√©l√©charger.");

          const blob = new Blob([lastResponse.content], { type: "text/html" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "site_par_IA.html";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }

      function openInNewTab() {
          const lastResponse = messages.slice().reverse().find(m => m.role === 'assistant');
          if (!lastResponse) return alert("Aucun site g√©n√©r√©.");
      
          const newWindow = window.open();
          newWindow.document.write(lastResponse.content);
          newWindow.document.close();
      }

      function downloadZip() {
          const lastResponse = messages.slice().reverse().find(m => m.role === 'assistant');
          if (!lastResponse) return alert("Aucun site g√©n√©r√© √† zipper.");
      
          const zip = new JSZip();
          let html = lastResponse.content;
      
          // S√©parer CSS & JS si pr√©sents
          const cssMatch = html.match(/<style[^>]*>([\s\S]*?)<\/style>/);
          const jsMatch = html.match(/<script[^>]*>([\s\S]*?)<\/script>/);
      
          if (cssMatch) {
              zip.file("style.css", cssMatch[1]);
              html = html.replace(cssMatch[0], '<link rel="stylesheet" href="style.css">');
          }
      
          if (jsMatch) {
              zip.file("script.js", jsMatch[1]);
              html = html.replace(jsMatch[0], '<script src="script.js"></script>');
          }
      
              zip.file("index.html", html);
      
              zip.generateAsync({ type: "blob" }).then(function (blob) {
                  const link = document.createElement("a");
                  link.href = URL.createObjectURL(blob);
                  link.download = "site_ia.zip";
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
              });
          }

      
    </script>
</body>
</html>
